---
name: Build roxctl Container Image

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      roxctl_version:
        description: 'RHACS roxctl version to package'
        required: false
        type: string
        default: ''
      version_bump:
        description: 'Container image version bump type'
        required: false
        type: choice
        options:
          - none
          - patch
          - minor
          - major
        default: 'none'

env:
  REGISTRY: quay.io
  IMAGE_NAME: tjungbau/roxctl-bin-container

jobs:
  lint:
    name: Lint Dockerfile
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Run hadolint
        uses: hadolint/hadolint-action@54c9adbab1582c2ef04b2016b760714a4bfde3cf # v3.1.0
        with:
          dockerfile: Dockerfile
          failure-threshold: warning
          ignore: DL3007,DL3029,DL3041

  version:
    name: Determine Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      roxctl_version: ${{ steps.get_roxctl.outputs.roxctl_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Bump version if requested
        if: github.event.inputs.version_bump != 'none' && github.event.inputs.version_bump != ''
        run: |
          CURRENT=$(cat VERSION | tr -d '[:space:]')
          MAJOR=$(echo $CURRENT | cut -d. -f1)
          MINOR=$(echo $CURRENT | cut -d. -f2)
          PATCH=$(echo $CURRENT | cut -d. -f3)
          
          case "${{ github.event.inputs.version_bump }}" in
            major)
              NEW_VERSION="$((MAJOR + 1)).0.0"
              ;;
            minor)
              NEW_VERSION="${MAJOR}.$((MINOR + 1)).0"
              ;;
            patch)
              NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))"
              ;;
          esac
          
          echo "$NEW_VERSION" > VERSION
          echo "Bumped version: $CURRENT â†’ $NEW_VERSION"

      - name: Get container image version
        id: get_version
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Container image version: $VERSION"

      - name: Get roxctl version
        id: get_roxctl
        run: |
          if [ -n "${{ github.event.inputs.roxctl_version }}" ]; then
            ROXCTL_VERSION="${{ github.event.inputs.roxctl_version }}"
          else
            ROXCTL_VERSION=$(cat ROXCTL_VERSION | tr -d '[:space:]')
          fi
          echo "roxctl_version=$ROXCTL_VERSION" >> $GITHUB_OUTPUT
          echo "roxctl version: $ROXCTL_VERSION"

      - name: Upload VERSION files
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: version-files
          path: |
            VERSION
            ROXCTL_VERSION
          retention-days: 1

  build:
    name: Build and Push Image
    runs-on: ubuntu-latest
    needs: [lint, version]
    permissions:
      contents: read
      packages: write
    outputs:
      image_digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Download VERSION files
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: version-files

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

      - name: Log in to Quay.io
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.QUAY_USER }}
          password: ${{ secrets.QUAY_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ needs.version.outputs.version }}
            type=raw,value=roxctl-v${{ needs.version.outputs.roxctl_version }}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        id: build
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          context: .
          platforms: linux/amd64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ needs.version.outputs.roxctl_version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output image details
        run: |
          echo "### Image Built Successfully ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Version | \`${{ needs.version.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| roxctl Version | \`${{ needs.version.outputs.roxctl_version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Digest | \`${{ steps.build.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY

  scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [build, version]
    if: github.event_name != 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.version.outputs.version }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@bffd034ab1518ad839a542b8a7356e13a240e076 # v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Trivy for console output
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.version.outputs.version }}
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'

  update-version:
    name: Update Version Files
    runs-on: ubuntu-latest
    needs: [build, version, scan]
    if: github.event_name != 'pull_request' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download VERSION files
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: version-files

      - name: Update roxctl version file if changed
        if: github.event.inputs.roxctl_version != ''
        run: |
          echo "${{ needs.version.outputs.roxctl_version }}" > ROXCTL_VERSION

      - name: Commit and push changes
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          ROXCTL_VERSION=$(cat ROXCTL_VERSION | tr -d '[:space:]')
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add VERSION ROXCTL_VERSION
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: bump to v${VERSION} with roxctl ${ROXCTL_VERSION} [skip ci]"
            git push
            echo "âœ“ Committed and pushed changes"
          fi

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [version, update-version]
    if: github.event_name != 'pull_request' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Create GitHub Release
        uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b # v1
        with:
          tag: v${{ needs.version.outputs.version }}
          name: Release v${{ needs.version.outputs.version }}
          body: |
            ## roxctl Container Image v${{ needs.version.outputs.version }}
            
            ### Container Image
            - **Image**: `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.version.outputs.version }}`
            - **roxctl Version**: `${{ needs.version.outputs.roxctl_version }}`
            - **Platform**: linux/amd64
            - **Base**: UBI10 Minimal
            
            ### Pull Image
            ```bash
            podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.version.outputs.version }}
            # or by roxctl version
            podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:roxctl-v${{ needs.version.outputs.roxctl_version }}
            ```
            
            ### Usage
            ```bash
            podman run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.version.outputs.version }} --help
            
            # Example: Check deployment
            podman run --rm \
              -e ROX_API_TOKEN=<token> \
              ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.version.outputs.version }} \
              central whoami --insecure-skip-tls-verify -e https://central.example.com:443
            ```
          draft: false
          prerelease: false
          makeLatest: true
          allowUpdates: true

